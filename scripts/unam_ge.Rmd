---
title: "Gender equality in UNAM's academic salaries"
author: "Alejandro Reyes"
date: 2019-07-27
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

The gender wage gap is the average difference in income received between men and women. According to the 2018 report of the Organisation for Economic Cooperation and Development, the gender wage gap is of 13.5% globally and 14% in Mexico [^1]. The reasons of the wage gap include discrimination, occupational segregation and gender roles established by society. Research stuies have estimated that gender wage gaps may not dissapear until the year 2109 [^2]. 

The National Autonomous University of Mexico (UNAM, for its accronym in spanish) is one of the biggest universities in Latin America. More than 10,000 scientist do their research in UNAM's laboratories. UNAM is funded from public spending and it is required by law to release all information about contracts and wages of each faculty member These data are available in the [UNAM's transparency website](http://www.transparencia.unam.mx/obligaciones/consulta/remuneracion-profesores). 

The current blog post describes a documented data analysis that addresses the question: **Is UNAM paying equally to their male and female faculty?**

[^1]: https://data.oecd.org/earnwage/gender-wage-gap.htm
[^2]: https://www.theguardian.com/society/2011/aug/31/cmi-equal-pay-report

```{r setup, include=FALSE}
knitr::opts_chunk$set( echo = TRUE, warnings=FALSE, message = FALSE, cache=TRUE )
```

# The data

## UNAM's wages data

As mentioned earlier, all UNAM's wage data is [publicly available](http://www.transparencia.unam.mx/obligaciones/consulta/remuneracion-profesores). I downloaded these data and saved them as tab-separated file. I also did some additional data wrangling to remove non-ASCII characters and have nicer column names. 

```{r}
library(magrittr)

###perl -pi -e 's/[^[:ascii:]]//g' UNAM_Remuneracion-profesores_2019-09-11_21.41.55.txt 
payData <- read.delim("UNAM_Remuneracion-profesores_2019-09-11_21.41.55.txt")
payData <- payData[,vapply( payData, function(x){length(unique(x))}, numeric(1)) > 1]
payData <- payData %>%
  dplyr::rename( 
    unidad_academica=`Unidad.acadmica`, 
    nombre=`Nombre.completo.del.profesor.a`,
    apellido_paterno=`Primer.apellido.del.profesor.a`,
    apellido_materno=`Segundo.apellido.del.profesor.a`,
    contrato=`Tipo.o.nivel.de.contratacin`,
    pago_bruto=`Remuneracin.bruta`,
    pago_neto=`Remuneracin.neta`,
    estimulos=`Estmulos.correspondientes.a.los.niveles.de.contratacin`,
    pago_total=`Monto.total.percibido`)

payData <- payData %>%
  dplyr::mutate_at( 
    c("pago_bruto", "pago_neto", "pago_total"), 
    function(x){as.numeric(gsub("\\$|,", "", as.character(x)))})
payData$id <- sprintf("investigador%0.9d", seq_len(nrow(payData)))

payData$academic_title <- payData$contrato
payData$academic_title <- gsub( "^\\S+ (.*)$", "\\1", payData$academic_title )

```

These data contains information for `r nrow(payData)` researchers, including full names, monthly salaries, academic ranks and academic departments.

## Creating catalogs of names per gender

I generated a catalog of names that are typically assigned to either males or females. Since Wikipedia has catalogs of male names and female names in several languages, I wrote a function to scrape these data. I ran this function for the Wikipedia pages of males and female names in Spanish, English, Italian, Portughese, French and German.  

```{r}
library(rvest)


parseWikiCatalogEn <- function( wikiPage, ex1="página", ex2="anterior", nextPageLab="página siguiente", pagePre="https://es.wikipedia.org"){
  mascNames <- c()
  keepFlag <- 1
  while( keepFlag > 0 ){
    pageNames <- wikiPage %>% 
      read_html %>% 
      html_node('body #content #bodyContent #mw-content-text #mw-pages') %>% 
      html_text
    if( grepl("previous|anterior", pageNames) ){
      pageNames <- strsplit( pageNames, sprintf("\\(%s|%s\\)", ex1, ex2))[[1]][4]
    }else{
      pageNames <- strsplit(pageNames, "more\\)\\.\n")[[1]][2]
    } ### fix
    pageNames <- strsplit( pageNames, "\n" )[[1]]
    pageNames <- gsub("[A-Z]{1}$", "", pageNames)
    pageNames <- gsub("siguiente\\)", "", pageNames)
    mascNames <- c(mascNames, pageNames)
    Sys.sleep(2)
    posNodes <- wikiPage %>% 
      read_html %>% 
      html_nodes('body #content #bodyContent #mw-content-text #mw-pages > a')
    posText <- posNodes %>% html_text
    posUrl <- posNodes %>% html_attr("href")
    nextLink <- which(posText == nextPageLab )
    if( length(nextLink) > 0 ){
      keepFlag <- 1
      }else{
      keepFlag <- 0
      }
    wikiPage <- unique(posUrl[nextLink])
    wikiPage <- paste0( pagePre, wikiPage )
    Sys.sleep(2)
  }
  mascNames <- mascNames[!(mascNames == " "|mascNames == "")]
  mascNames
}

maleWikiLink <- 
  "https://es.wikipedia.org/w/index.php?title=Categor%C3%ADa:Nombres_masculinos&pageuntil=Columbano+%28nombre%29#mw-pages"
femaleWikiLink <- 
  "https://es.wikipedia.org/w/index.php?title=Categor%C3%ADa:Nombres_femeninos&pageuntil=Idoya#mw-pages"
maleNames <- parseWikiCatalogEn( maleWikiLink )
femaleNames <- parseWikiCatalogEn( femaleWikiLink )
femaleNamesExt <- lapply(
  c( italian=
       "https://en.wikipedia.org/w/index.php?title=Category:Italian_feminine_given_names&#mw-pages",
     portuguese=
       "https://en.wikipedia.org/w/index.php?title=Category:Portuguese_feminine_given_names&pageuntil=Ida+%28given+name%29#mw-pages",
    german=
      "https://en.wikipedia.org/w/index.php?title=Category:German_feminine_given_names&#mw-pages", 
    english=
      "https://en.wikipedia.org/w/index.php?title=Category:English_feminine_given_names&pageuntil=Ida+%28given+name%29#mw-pages",
    french=
      "https://en.wikipedia.org/w/index.php?title=Category:French_feminine_given_names&pageuntil=Ida+%28given+name%29#mw-pages"), 
  parseWikiCatalogEn, ex1="previous", ex2="page", nextPageLab="next page", pagePre="https://en.wikipedia.org" )
maleNamesExt <- lapply(
  c( 
    italian=
      "https://en.wikipedia.org/w/index.php?title=Category:Italian_masculine_given_names&#mw-pages",
    portuguese=
      "https://en.wikipedia.org/w/index.php?title=Category:Portuguese_masculine_given_names&pageuntil=Ida+%28given+name%29#mw-pages",
    german=
      "https://en.wikipedia.org/w/index.php?title=Category:German_masculine_given_names&#mw-pages", 
    english=
      "https://en.wikipedia.org/w/index.php?title=Category:English_masculine_given_names&pageuntil=Ida+%28given+name%29#mw-pages",
    french=
      "https://en.wikipedia.org/w/index.php?title=Category:French_masculine_given_names&pageuntil=Ida+%28given+name%29#mw-pages"), 
  parseWikiCatalogEn, ex1="previous", ex2="page", nextPageLab="next page", pagePre="https://en.wikipedia.org" )

maleNamesExt <- unlist(maleNamesExt)
femaleNamesExt <- unlist(femaleNamesExt)
femaleNamesExt <- femaleNamesExt[!femaleNamesExt %in% maleNames]
maleNamesExt <- maleNamesExt[!maleNamesExt %in% femaleNames]
maleNames <- c( maleNames, (maleNamesExt) )
femaleNames <-c( femaleNames, (femaleNamesExt) )

```

Since I noticed that Wikipedia catalogs were missing many names that are common in Mexico, I added manually all names that appeared at least 5 times in the list of UNAM's professors. 

```{r}

maleNames <- c( maleNames, 
                c("VLADIMIR", "JESUS", "CONRAD", "BORIS", "STALIN", "REY", "GENARO", 
                  "JUSTO", "JUSTINO", "ERIK", "ANGEL", "ALAIN", "HAZAEL", "RAMON", "ALONSO", 
                  "SERAFIN", "OTONIEL", "ISAURO", "ALAN", "HIBRAIM", "EFREN", "OCTAVIO", 
                  "MOISES", "FRANCOIS", "JUVENTINO", "ANGEL", "ESTUARDO", "VLADISLAV", 
                  "ELVIA", "RUBEN", "FREDY", "MARGARITO", "OTHON", "BALTAZAR", "HERNAN", 
                  "LEONEL", "PAVEL", "NARCISO", "EMMANUEL", "FILIBERTO", "RAMIRO", 
                  "ERICK", "RAYMUNDO", "EFRAIN", "ULISES", "RENAN", "ARCADIO") )
femaleNames <- c( femaleNames, 
                  c("GUILLERMINA", "CARMEN", "EVANGELINA", "REYNA", "GUADALUPE", "NOHEMI", 
                    "MARISELA", "ALEXA", "MARTHA", "FLOR", "KATY", "TERESITA", "SELENA", 
                    "ARCELIA", "ELVA", "ILIANA", "MINELIA", "LASTENIA", "GINA", 
                    "CITLALIT", "LIBERTAD", "MARIANELA", "EVERTINA", "LEDA", "SILVANA", 
                    "ELIETE", "YLENIA", "XOCHITLALLI", "DULCE", "LIBIA", "ADELINA", 
                    "JEANNETTE", "SOLEDAD", "MAIRA", "MAYRA", "ITZEL", "SOCORRO", 
                    "GRACIELA", "IIGA", "ELBA", "CLORINDA", "KARLA", "CLAUDETTE", "IDANIA", 
                    "NORKA", "AMERICA", "TRILCE", "FABIOLA", "OLIVAMA", "ELIA", "NALLELY", 
                    "NATTIE", "MATILDE", "YURI", "CELINA", "ESMERALDA", "EVELIA", "JAZMIN", 
                    "LIGIA", "MANUELA", "NELLY", "ROSALVA", "ARIEL", "CITLALI", "IVETTE", 
                    "LILIAN", "LUCERO", "MIRNA", "NAYELI", "NIDIA", "ORALIA", "PERLA", 
                    "ROSAURA", "ROXANA", "YURI", "ZOILA", "FILIBERTO", "ISELA", "REMEDIOS", 
                    "LUCILA", "MARISOL", "MINERVA", "YADIRA", "ZOILA", "ALEJANDRINA", 
                    "EMILIA", "NIEVES", "REGINA", "YAZMIN", "ELVIA", "LIZBETH", "ERENDIRA", 
                    "FRANCISCA", "REFUGIO", "DANIELA", "MARICELA", "IVONNE", "ANTONIETA", 
                    "MIRIAM", "LEONOR", "JOSEFINA", "LILIA") )
names( maleNames ) <- NULL
names( femaleNames ) <- NULL

namesCatalog <- rbind(
  data.frame( gender=rep( "Male", length( maleNames ) ), 
              name=maleNames, stringsAsFactors=FALSE),
  data.frame( gender=rep( "Female", length( femaleNames ) ), 
              name=femaleNames, stringsAsFactors = FALSE ) )

namesCatalog <- namesCatalog %>%
  dplyr::filter( nchar(name) > 1 ) %>%
  dplyr::mutate( nameMod=gsub("\\(.*\\).*", "", name ) ) %>%
  dplyr::mutate( nameMod=gsub(" $", "", nameMod ))

unwanted_array = list('Š'='S', 'š'='s', 'Ž'='Z', 'ž'='z', 'À'='A', 'Á'='A', 'Â'='A', 'Ã'='A', 'Ä'='A', 'Å'='A', 'Æ'='A', 'Ç'='C', 'È'='E', 'É'='E', 'Ê'='E', 'Ë'='E', 'Ì'='I', 'Í'='I', 'Î'='I', 'Ï'='I', 'Ñ'='N', 'Ò'='O', 'Ó'='O', 'Ô'='O', 'Õ'='O', 'Ö'='O', 'Ø'='O', 'Ù'='U', 'Ú'='U', 'Û'='U', 'Ü'='U', 'Ý'='Y', 'Þ'='B', 'ß'='Ss', 'à'='a', 'á'='a', 'â'='a', 'ã'='a', 'ä'='a', 'å'='a', 'æ'='a', 'ā'='a', 'ç'='c', 'è'='e', 'é'='e', 'ê'='e', 'ë'='e', 'ì'='i', 'í'='i', 'ī'='i', 'î'='i', 'ï'='i', 'ł'='l', 'ð'='o', 'ñ'='n', 'ò'='o', 'ó'='o', 'ō'='o', 'ô'='o', 'õ'='o', 'ö'='o', 'ø'='o', 'ś'='s', 'ù'='u', 'ú'='u', 'û'='u', 'ū'='u', 'ý'='y', 'ý'='y', 'þ'='b', 'ÿ'='y', 'ż'='z' )

namesCatalog$nameMod <- chartr( paste(names(unwanted_array), collapse=''),
         paste(unwanted_array, collapse=''),
         namesCatalog$nameMod )
namesCatalog$nameMod <- toupper(namesCatalog$nameMod)
namesCatalog <- dplyr::rename( namesCatalog, nombre=nameMod )
namesCatalog <- unique(namesCatalog)
```

I discarded most names that are given to both males and females. But for some of these ambiguous cases, I assigned a gender based on the gender that is more common in Mexico for that name. For example, the name "Angel" is listed in Wikipedia as a name for both females and males, but it is more common for males in Mexico. 

```{r}

namesCatalog <- namesCatalog[!(namesCatalog$nombre == "ANGEL" & namesCatalog$gender == "Female"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "ELVIA" & namesCatalog$gender == "Male"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "FILIBERTO" & namesCatalog$gender == "Female"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "ISIDORO" & namesCatalog$gender == "Female"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "ARIEL" & namesCatalog$gender == "Male"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "EVELYN" & namesCatalog$gender == "Male"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "ROSARIO" & namesCatalog$gender == "Male"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "AIME" & namesCatalog$gender == "Male"),]
namesCatalog <- namesCatalog[!(namesCatalog$nombre == "SOL" & namesCatalog$gender == "Male"),]

neutralNames <- intersect( 
  namesCatalog$nombre[namesCatalog$gender == "Male"],
  namesCatalog$nombre[namesCatalog$gender == "Female"] )

namesCatalog <- namesCatalog[!namesCatalog$nombre %in% neutralNames,]
```

I collected `r sum(namesCatalog$gender == "Male")` male names and `r sum(namesCatalog$gender == "Female")` female names. 

# Females constitute 44% of UNAM's faculty

Then, I used my name catalog to assign a gender to each faculty member based on their first names. In Mexico, it is common for people to have more than one first name and names like "María José" can be tricky, since "María" is a female name, "José" is a male name and the combination of the two, "María José", is a name given to females. To resolve these cases, I considered both the gender of the first first name and the consensus gender of the individual names. In general, these two strategies gave almost identical results. But the final assignment was given by a perfect match between my name catalog and the full first name of a researcher. Then, for names without a perfect match, I selected the gender of the first first name or the consensus gender of the names whenever the first first name was uninformative. 

```{r}

namesDf <- as.data.frame(payData[,c("nombre", "id")])
namesDf$nombre <- strsplit( as.character(payData$nombre), " " )
namesDf <- tidyr::unnest(namesDf, cols = c(nombre))
namesDf <- dplyr::left_join( namesDf, namesCatalog[,c("nombre", "gender")] )
namesDf <- unique( namesDf )
namesDf <- namesDf %>% 
  dplyr::mutate( nameOrder=ave(id, id, FUN=seq_along) )

genderFirstName <- namesDf %>% 
  dplyr::filter( nameOrder == 1 ) %>%
  dplyr::select( id, gender )

genderConsensus <- namesDf %>%
  dplyr::group_by( id, gender ) %>%
  dplyr::summarize( cnt=dplyr::n() ) %>%
  na.omit() %>%
  reshape2::dcast( id ~ gender, value.var="cnt", fun.aggregate = length) %>%
  dplyr::mutate( 
    genderConsensus=dplyr::case_when(
      Male > Female ~ "Male", 
      Female > Male ~ "Female",
      (Male == Female & Female > 0) ~ "Ambiguous",
      is.numeric(Male) ~ "Unknown" )
  )

genderComplex <- namesCatalog %>%
  dplyr::filter( grepl( " ", nombre ) ) %>%
  dplyr::select( nombre, gender ) %>%
  dplyr::left_join( payData[,c("id", "nombre")]) %>%
  na.omit() %>%
  dplyr::select( id, gender ) %>%
  dplyr::rename( genderComplex=gender )

genderAssignment <- dplyr::full_join( genderConsensus, genderFirstName )
genderAssignment <- dplyr::full_join( genderAssignment, genderComplex )

genderAssignment$genderFinal <- with( genderAssignment, 
       ifelse( !is.na(genderComplex), genderComplex, 
               ifelse( genderConsensus %in% c("Ambiguous", "Other"), 
                       gender, genderConsensus ) ) )

payData <- payData %>% 
  dplyr::left_join( genderAssignment[,c("id", "genderFinal")] ) %>%
  dplyr::rename( gender=genderFinal ) %>%
  dplyr::select( -pago_bruto )

payData$gender[is.na(payData$gender)] <- "Unknown"
```

Based on these strategies, I could assign a gender to `r sum(payData$gender %in% c("Male", "Female"))` faculty members, which corresponds to `r round(100*(sum(payData$gender %in% c("Male", "Female"))/nrow(payData)))`% of UNAM's academics. Of the people that I could assign a gender, `r sum(payData$gender %in% "Female")` (`r round(100*sum(payData$gender %in% "Female")/sum(payData$gender %in% c("Male", "Female")))`%) were females. This percentage of females estimate is consistent with [UNAM's reports](https://www.gaceta.unam.mx/vive-la-unam-proceso-de-avance-en-igualdad-de-genero/).

# High-rank positions are dominated by males

```{r, echo=FALSE}

library(ggplot2)
library(ggpubr)
library(cowplot)
theme_set(theme_cowplot())

pval <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female") ) %>%
  wilcox.test( `pago_total`~gender, data=. )

meanDiff <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female") )  %>%
  dplyr::group_by( gender ) %>%
  dplyr::summarise( tot=mean(pago_total)) %>%
  tidyr::pivot_wider( names_from=gender, values_from=tot ) %>%
  dplyr::mutate( diff=Male - Female ) %>%
  dplyr::pull(diff)

```

**I found a significant difference between the wages earned by females and males ($`r paste0("p = ", gsub("e", " * 10^{", format( pval$p.value, digits=2)), "}")`$). On average, males earn `r round(meanDiff)` MXN more than females.** The plot below shows the distribution of wages for each gender. 

```{r}
payData %>%
  dplyr::filter( gender %in% c("Male", "Female") ) %>%
  ggplot( aes( pago_total, col=gender ) ) +
  geom_density() +
  geom_segment(
    aes(x = x1, y = y1+.2e-5, xend = x1, yend = y1),
    data = data.frame(x1=c(70000, 125000), y1=c(1.2e-5, .2e-5) ),
    inherit.aes=FALSE,
    arrow = arrow(length = unit(0.03, "npc") ) ) +
  labs(y="Density", x="UNAM's monthly salary (MXN)", col="") +
  scale_colour_manual(values=c(Female="#e41a1c", Male="#377eb8"))
```

These distributions show several modes, and there are two peaks towards the higher ranking salaries that are higher for males that for females (see the arrows). These patterns in the distribution suggest that higher rank positions are dominated by males. 

Su I asked whether higher academic titles are dominated by males. To do so, I plotted the percentage of females in each academic title as a function of the average salary in that title. 

```{r, fig.height=3, fig.width=4}

contractSummary <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female") ) %>%
  dplyr::group_by( academic_title ) %>%
  dplyr::summarise( num=dplyr::n(), avePay=mean( pago_total ) ) %>%
  dplyr::arrange( desc(avePay) )

payPerGenderSumm <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female") ) %>%
  dplyr::group_by( academic_title, gender ) %>%
  dplyr::summarise( num=dplyr::n() ) %>%
  tidyr::pivot_wider(names_from="gender", values_from="num", values_fill=list(num=0)) %>%
  dplyr::mutate( femalePercent=100*(Female/(Male+Female) )) %>%
  dplyr::right_join( contractSummary ) %>%
  dplyr::ungroup() 

payPerGenderSumm %>%
#  dplyr::filter( num > 3 ) %>%
  ggplot( aes( avePay/1000, femalePercent) ) +
  geom_point() +
  geom_hline(yintercept=50, col="red") +
  ylim(0, 100) +
  labs(x="Monthly salary (x 1,000 MXN)", y="Percentage of females")

```

One can see from this plot that the split between males and females is centered around 50% for most positions. **Nevertheless, among the top 6 academic titles that are better payed, the percentage of females is way below 50%**. 

The code below pulls the contracts where the average salary is above 50000 MXN monthly. For all except one contract, the percentage of females is below 40%. The academic titles in this list are most prestigious positions such as Emeritus Faculty, *Investigadores/Profesores Titulares* (equivalent to full professor in the US system).

```{r}

payPerGenderSumm %>%
  dplyr::filter( avePay > 50000) %>%
  dplyr::select( academic_title, num, femalePercent, avePay )

```

Interestingly, several half-time senior positions are mostly given to males.

```{r}

payPerGenderSumm %>%
  dplyr::filter( femalePercent < 40, grepl("MEDIO TIEMPO", academic_title ) ) %>%
  dplyr::select( academic_title, femalePercent, avePay )

```

# Females earn 607 MXN more than males with the same contract

The analysis so far shows an overall difference of male faculty earning more money than female faculty. This difference is explained by male faculty members having higher academic titles than female faculty members. Now I asked a sligthly different question: **is there a gender pay gap for faculty members even when they have the same contract?** 

To answer this question, I fitted a linear model

$$y_{i} = \beta_{0} + \beta_{1}^{female}x_{1i} + \sum_{j=2}^{q} {{\beta}_{j}^{contract}x_{ji}} + 
\epsilon_{i}, $$

where $y_{i}$ is the salary of individual $i$ and $q$ is the number of possible contracts. $\beta_{0}$ is the intercept term, which estimates the mean salary for males that have an arbitrary base level contract. $x_{1i}$ is a dummy variable that $x_{1i}=1$ if individual $i$ is a female and that $x_{1i}=0$ if individual $i$ is a male. $x_{ji}$ are dummmy variables that $x_{ji}=1$ if individual $i$ has a contract $j$ and $x_{ji}=0$ otherwise. $\epsilon_{i}$ is the error term that is normally distributed.

The coefficient of interest in the model is $\beta_{1}^{female}$, which estimates the difference in salary that females receive compare to males after adjusting for the contract types, which are estimated by the ${\beta}_{j}^{contract}$ coefficients. 

```{r}

testable <- as.character( payData %>%
  dplyr::filter( gender %in% c("Male", "Female") ) %>%
  dplyr::group_by( contrato ) %>%
  dplyr::summarise( num=dplyr::n() ) %>%
  dplyr::filter( num > 15 ) %>%
  dplyr::pull( contrato ) )

minN <- min( payData[payData$contrato %in% testable,] %>%
  dplyr::group_by( gender, contrato ) %>%
  dplyr::summarise( n=dplyr::n() ) %>%
  dplyr::pull( n ) )

stopifnot( minN > 0 )

fit <- lm( pago_total ~ contrato + gender,
          data={
            dplyr::filter(payData, gender %in% c("Male", "Female"), contrato %in% testable ) %>%
              dplyr::mutate( gender=factor(gender, levels=c("Male", "Female"))) } )

coefFemale <- coefficients(fit)[["genderFemale"]]
coefFemale

pvalLm <- broom::tidy(anova(fit)) %>%
  dplyr::filter( term == "gender" ) %>%
  dplyr::pull(p.value)
pvalLm

```

The $p$-value of an analysis of variance indicates that there is a significant difference in the salaries that females earn compare to males that are employed with the same contracts **But contrary to what I was expecting, the resulting  $\beta_{1}^{female}$ coefficient indicates that females actually earn `r round(coefFemale)` MXN more than males.** I found this result to be counterintuitive, given that historically (due to unfairness and discrimination) males typically more than females.

To further understand the source of this wage differences, I explored the difference in pay gaps in each contract. I tested for each contract whether there are differences in salaries between genders

```{r, fig.height=3, fig.width=6}

contractSummary <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female") ) %>%
  dplyr::group_by( contrato ) %>%
  dplyr::summarise( num=dplyr::n(), avePay=mean( pago_total ) ) %>%
  dplyr::arrange( desc(avePay) )

payPerGenderSumm <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female") ) %>%
  dplyr::group_by( contrato, gender ) %>%
  dplyr::summarise( num=dplyr::n() ) %>%
  tidyr::pivot_wider(names_from="gender", values_from="num", values_fill=list(num=0)) %>%
  dplyr::mutate( femalePercent=100*(Female/(Male+Female) )) %>%
  dplyr::right_join( contractSummary ) %>%
  dplyr::ungroup() 

differentPays <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female"), contrato %in% testable ) %>%
  dplyr::mutate(gender=factor(gender, levels=c("Female", "Male"))) %>%
  dplyr::group_by( contrato ) %>%
  dplyr::group_map( ~ cbind( 
    broom::tidy( t.test( pago_total ~ gender, data=.x )),
    contrato=unique( .x$contrato ), stringsAsFactors=FALSE), keep=TRUE ) %>%
  dplyr::bind_rows() %>%
  dplyr::select( estimate, estimate1, estimate2, conf.low, conf.high, contrato, p.value ) %>%
  dplyr::mutate( q.value = p.adjust( p.value, method="BH")) %>%
  dplyr::filter( q.value < 0.1 ) %>%
  dplyr::left_join(  payPerGenderSumm[,c("contrato", "avePay")] ) %>%
  dplyr::mutate( aveDiff=(100*estimate1/estimate2) - 100 )

nrow(differentPays)

```

**Two full-time contracts were significant at a false discovery rate of 10%.** The plot below shows the distributions of wages for these two contracts in each gender.

```{r, fig.width=5, fig.height=2.8}
payData %>%
  dplyr::filter( 
    contrato == dplyr::pull(differentPays, contrato), 
    gender %in% c("Male", "Female") ) %>%
  dplyr::mutate( contrato = gsub(" TIEMPO COMPLETO|^\\S+ ", "", contrato) ) %>%
  ggplot( aes(pago_total/1000, col=gender ) ) +
  geom_density() +
  facet_wrap( ~contrato ) +
  theme(legend.pos="top", axis.line=element_blank()) +
  labs(x="Salary (1,000 MXN)", y="Density", col="") +
  panel_border(colour="black", size=1) +
  scale_colour_manual(values=c(Female="#e41a1c", Male="#377eb8"))
```

In these two positions, *Investigador Titular B* and *Profesor Titular C*, the average of females is `r round(differentPays$aveDiff[differentPays$contrato == "I6593 INVESTIGADOR TITULAR B TIEMPO COMPLETO"], 1)`% and `r round(differentPays$aveDiff[differentPays$contrato == "D6696 PROFESOR TITULAR C TIEMPO COMPLETO"], 1)`% more than the average of males, respectively. Although significant, these differences are minimal.

The plot below shows the differences between the salaries of females compared to males ($y$-axis) for each contract (each dot) plotted as a function of the average salary of the contract ($x$-axis). The points are coloured according to the percentage of females in that contract and I'm drawing the 95% confidence intervals of the mean differences. Dots above the horizontal dotted line indicate that the average in salaries is higher in females than in males, and dots below the horizontal dotted line indicate that the average salary for females is lower compare to those of males. 

```{r, fig.height=3.2, fig.width=5.9}

cols <- c( colorRampPalette( c("#b2182b", "#f4a582", "#bababa"), bias=0.5)(100),
   rev(colorRampPalette( c( "#2166ac", "#92c5de", "#bababa"), bias=0.5)(100) ) )

payData %>%
  dplyr::filter( gender %in% c("Male", "Female"), contrato %in% testable ) %>%
  dplyr::mutate(gender=factor(gender, levels=c("Female", "Male"))) %>%
  dplyr::group_by( contrato ) %>%
  dplyr::group_map( ~ cbind( 
    broom::tidy(t.test( pago_total ~ gender, data=.x )),
    contrato=unique( .x$contrato ), stringsAsFactors=FALSE ), keep=TRUE ) %>%
  dplyr::bind_rows() %>%
  dplyr::select( estimate, conf.low, conf.high, contrato, p.value ) %>%
  dplyr::mutate( q.value = p.adjust( p.value, method="BH")) %>%
  dplyr::left_join( payPerGenderSumm ) %>%
  ggplot( aes( avePay/1000, estimate/1000, col=femalePercent) ) +
  geom_errorbar(aes(ymin=conf.low/1000, ymax=conf.high/1000), width=.1) +
  geom_point() + 
  scale_colour_gradientn(colours=cols,  limits=c(0, 100)) +
  geom_hline(yintercept=0, col="black", alpha=0.95, linetype="longdash") +
  annotate("text", x=27, y=6.5, label="↑ Females earn more", color = "black") +
  annotate("text", x=27, y=-6.5, label="↓ Males earn more  ", color = "black") +
  ylim(-6.5, 15) +
  labs(x="Average salary (1,000 MXN)", 
       y="Difference in means of salaries\n(Female-Male)",
       col="% of females")

```


```{r, echo=FALSE}

numAboveZero <- payData %>%
  dplyr::filter( gender %in% c("Male", "Female"), contrato %in% testable ) %>%
  dplyr::mutate(gender=factor(gender, levels=c("Female", "Male"))) %>%
  dplyr::group_by( contrato ) %>%
  dplyr::group_map( ~ cbind( 
    broom::tidy(t.test( pago_total ~ gender, data=.x )),
    contrato=unique( .x$contrato ), stringsAsFactors=FALSE ), keep=TRUE ) %>%
  dplyr::bind_rows()

```

For `r round(100*sum(numAboveZero$estimate > 0)/nrow(numAboveZero))`% of the contracts (`r sum(numAboveZero$estimate > 0)` out of `r nrow(numAboveZero)`), the average was higher for females than for males (i.e. the dots are above the horizontal dotted line). This explains why the $\beta_{1}^{female}$ coefficient was significant in the linear model. However, the 95% confidence intervals overlap with the zero line for `r sum(Vectorize(dplyr::between)(0, numAboveZero$conf.low, numAboveZero$conf.high))` of the contracts, which is why only the remaining `r sum(!Vectorize(dplyr::between)(0, numAboveZero$conf.low, numAboveZero$conf.high))` contracts, *Investigador Titular B* and *Profesor Titular C*, are significant in the contract-wise tests.

